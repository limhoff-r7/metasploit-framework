require 'spec_helper'

describe Metasploit::Framework::Attempt::Exploit::Creation do
  include_context 'Metasploit::Framework::Attempt::Creation::Base'

  subject(:creation) do
    described_class.new(
        attempted_at: attempted_at,
        cache_exploit_class: cache_exploit_class,
        exploit_instance: exploit_instance,
        exploited: exploited,
        host: host,
        service: service,
        vuln: vuln
    )
  end

  #
  # lets
  #

  let(:host) do
    FactoryGirl.build(
        :mdm_host
    )
  end

  let(:service) do
    FactoryGirl.build(
        :mdm_service,
        host: host
    )
  end

  let(:vuln) do
    FactoryGirl.build(
        :mdm_vuln,
        host: host,
        service: service
    )
  end

  context 'validations' do
    it { should validate_presence_of :host }
  end

  context 'attempt_type' do
    subject(:attempt_type) do
      described_class.attempt_type
    end

    it { should == :exploit }
  end

  context '#attributes' do
    subject(:attributes) do
      creation.send(:attributes)
    end

    it_should_behave_like 'Metasploit::Framework::Attempt::Creation::Single#attributes'

    context '[:host]' do
      subject(:attributes_host) do
        attributes[:host]
      end

      it 'uses #host' do
        expect(attributes_host).to eq(host)
      end
    end

    context '[:service]' do
      subject(:attributes_service) do
        attributes[:service]
      end

      it 'uses #service' do
        expect(attributes_service).to eq(service)
      end
    end
  end

  context '#create' do
    subject(:create) do
      creation.create
    end

    it 'uses exploit_attempts association on #cache_exploit_class' do
      expect(cache_exploit_class).to receive(:exploit_attempts).and_call_original

      create
    end

    it 'uses #create! so validation errors are raised as exception and not missed in the framework.log' do
      expect(cache_exploit_class.exploit_attempts).to receive(:create!)

      create
    end

    it 'passes #attributes to #create!' do
      attributes = double('#attributes')
      expect(creation).to receive(:attributes).and_return(attributes)
      expect(cache_exploit_class.exploit_attempts).to receive(:create!).with(attributes)

      create
    end

    it 'creates an Mdm::ExploitAttempt' do
      expect {
        create
      }.to change(Mdm::ExploitAttempt, :count).by(1)
    end
  end
end